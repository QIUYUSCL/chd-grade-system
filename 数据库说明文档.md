**长安大学成绩管理系统数据库设计说明文档（修订版 V1.1）**

**文档信息**

----------------------------------- -----------------------------------
  项目                                内容

  文档版本                            **V1.1（2025年12月修订）**

  适用系统                            长安大学成绩管理系统

  数据库版本                          MySQL 8.0+

  设计日期                            2025年11月

  修订内容                            补充唯一性约束、生成列实现
----------------------------------- -----------------------------------

**1. 概述**

**1.1 文档目的**

本文档详细说明长安大学成绩管理系统数据库的设计规范、表结构、字段含义、关联关系及安全设计，为系统开发、维护、运维提供统一的数据库参考依据。**本次修订重点补充了业务唯一性约束与数据完整性哈希的实现细节。**

**1.2 系统背景**

本数据库用于管理长安大学学生成绩相关数据，涵盖学生、教师、课程、成绩记录及安全审计等核心模块，满足成绩录入、存储、校验、审计的全流程需求，保障数据完整性、安全性和可追溯性。

**1.3 设计原则**

**数据完整性**：通过**业务唯一约束**、外键约束、非空约束确保关联数据一致性；

**安全性**：采用哈希防篡改、审计日志、**数据加密存储**等机制；

**性能优化**：针对高频查询字段建立索引，**唯一索引同时保障写入安全**；

**兼容性**：基于MySQL 8.0+设计，**利用虚拟生成列实现轻量级防篡改校验**；

**可维护性**：表结构命名规范、注释完整，便于后期扩展和维护。

---

**2. 环境要求**

----------------------------------- ----------------------------------------
  类别                                要求

  数据库类型                          MySQL（8.0及以上版本）

  存储引擎                            InnoDB（支持外键、事务、行级锁）

  字符集                              utf8mb4（兼容全量中文/特殊字符）

  排序规则                            utf8mb4_unicode_ci / utf8mb4_0900_ai_ci

  运行环境                            Linux/Windows Server 2019+
----------------------------------- ----------------------------------------

---

**3. 数据库整体结构**

**3.1 数据库基本信息**

数据库名：`chd_grade_db`

核心表数量：**5张**（学生表、教师表、课程表、成绩记录表、安全审计日志表）

表间关系：成绩记录表为核心关联表，关联学生、教师、课程表；审计日志表独立记录所有数据操作行为。

**3.2 表结构总览**

----------------------- ----------------------- ------------------------------------------------
  表名                    中文名称                核心功能

  students                学生信息表              存储学生基础信息，作为成绩记录的关联父表

  teachers                教师信息表              存储教师基础信息，关联课程和成绩录入操作

  courses                 课程信息表              存储课程基础信息，关联任课教师

  grade_records           成绩记录表              **核心业务表**，存储加密成绩、考试类型、状态，**强制业务唯一性**

  security_log            安全审计日志表          记录所有数据操作行为，支持溯源和防篡改校验
----------------------- ----------------------- ------------------------------------------------

---

**4. 详细表结构说明**

**4.1 学生信息表（students）**

--------------- -------------- ------------------- ------------------ -----------------------------
  字段名          数据类型       约束条件            注释               补充说明

  student_id      VARCHAR(20)    PRIMARY KEY         学号               唯一标识学生，字符集utf8mb4

  name            VARCHAR(50)    NOT NULL            姓名               -

  password_hash   VARCHAR(100)   NOT NULL            密码哈希(BCrypt)   存储加密后的密码，不存明文

  class_name      VARCHAR(50)    NULL                班级               如"软件2101"

  major           VARCHAR(50)    NULL                专业               如"软件工程"

  email           VARCHAR(100)   NULL                邮箱               学校统一邮箱

  created_at      TIMESTAMP      DEFAULT             创建时间           自动记录数据插入时间
                                 CURRENT_TIMESTAMP                      

  **索引**        idx_class      -                   班级索引           优化按班级查询学生的性能
                  (class_name)                                          
--------------- -------------- ------------------- ------------------ -----------------------------

**4.2 教师信息表（teachers）**

--------------- ---------------- ------------------- ------------------ -----------------------------
  字段名          数据类型         约束条件            注释               补充说明

  teacher_id      VARCHAR(20)      PRIMARY KEY         教师编号           唯一标识教师，字符集utf8mb4

  name            VARCHAR(50)      NOT NULL            姓名               -

  password_hash   VARCHAR(100)     NOT NULL            密码哈希(BCrypt)   存储加密后的密码，不存明文

  department      VARCHAR(50)      NULL                院系               如"信息工程学院"

  title           VARCHAR(20)      NULL                职称               如"教授""讲师"

  email           VARCHAR(100)     NULL                邮箱               学校统一邮箱

  created_at      TIMESTAMP        DEFAULT             创建时间           自动记录数据插入时间
                                   CURRENT_TIMESTAMP                      

  **索引**        idx_department   -                   院系索引           优化按院系查询教师的性能
                  (department)                                            
--------------- ---------------- ------------------- ------------------ -----------------------------

**4.3 课程信息表（courses）**

-------------- ------------------- ---------------------- -------------- ------------------------------------
  字段名         数据类型            约束条件               注释           补充说明

  course_id      VARCHAR(20)         PRIMARY KEY            课程编号       唯一标识课程，字符集utf8mb4

  course_name    VARCHAR(100)        NOT NULL               课程名称       如"数据结构"

  credit         DECIMAL(3,1)        NULL                   学分           保留1位小数，如4.0、2.5

  department     VARCHAR(50)         NULL                   开课院系       课程所属院系

  teacher_id     VARCHAR(20)         NULL                   任课教师       关联教师表的teacher_id

  semester       VARCHAR(20)         NULL                   学期           格式"年-年-学期"，如"2024-2025-1"

  created_at     TIMESTAMP           DEFAULT                创建时间       自动记录数据插入时间
                                     CURRENT_TIMESTAMP                     

  **外键**       fk_course_teacher   REFERENCES             关联教师表     教师删除时，课程的任课教师设为NULL
                 (teacher_id)        teachers(teacher_id)                  
                                     ON DELETE SET NULL                    

  **索引**       idx_teacher         -                      教师索引       优化按教师查询课程的性能
                 (teacher_id)                                           
-------------- ------------------- ---------------------- -------------- ------------------------------------

**4.4 成绩记录表（grade_records）** **【本次修订核心表】**

------------------------ ------------------------------- ------------------------- ---------------- --------------------------------------------------------------------------------
  字段名                   数据类型                        约束条件                  注释             补充说明

  record_id                BIGINT                          AUTO_INCREMENT、PRIMARY   成绩记录ID       自增主键，唯一标识每条成绩记录
                                                           KEY                                        

  student_id               VARCHAR(20)                     NOT NULL                  学号             关联学生表，字符集utf8mb4

  course_id                VARCHAR(20)                     NOT NULL                  课程编号         关联课程表，字符集utf8mb4

  daily_score_encrypted    VARCHAR(200)                    NULL                      平时成绩(加密)   **AES加密存储**，非明文

  final_score_encrypted    VARCHAR(200)                    NULL                      期末成绩(加密)   **AES加密存储**，非明文

  makeup_score_encrypted   VARCHAR(200)                    NULL                      补考成绩(加密)   仅补考记录有值，**AES加密**

  total_score_encrypted    VARCHAR(200)                    NULL                      总成绩(加密)     **AES加密存储**，非明文

  exam_type                ENUM('正考','补考')             DEFAULT '正考'            考试类型         **区分正考/补考两类考试**

  status                   ENUM('DRAFT','SUBMITTED')       DEFAULT 'DRAFT'           状态             **DRAFT=草稿（可修改），SUBMITTED=已提交（锁定）**

  teacher_id               VARCHAR(20)                     NOT NULL                  录入教师         关联教师表，字符集utf8mb4

  semester                 VARCHAR(20)                     NOT NULL                  学期             格式"年-年-学期"

  created_at               TIMESTAMP                       DEFAULT                   创建时间         自动记录数据插入时间
                                                           CURRENT_TIMESTAMP                          

  updated_at               TIMESTAMP                       DEFAULT                   更新时间         **自动记录数据修改时间**
                                                           CURRENT_TIMESTAMP                          
                                                           ON UPDATE                                  
                                                           CURRENT_TIMESTAMP                          

  **【新增】**                                                                                                   **-- 本次V1.1修订重点 --**

  data_hash                VARCHAR(64)                     **VIRTUAL生成列**         数据完整性哈希   **SHA2哈希，基于核心字段实时计算，防篡改**

  **【核心约束】**                                                                                               **-- 本次V1.1修订重点 --**

  **唯一索引**             **uk_grade**                    **UNIQUE KEY**            **业务唯一性约束** **防止同一学生同一课程同一考试类型重复录入（含状态区分）**

                           **(student_id, course_id, semester, exam_type, status)**

  **外键1**                fk_grade_student                REFERENCES                关联学生表       **学生删除时，同步删除成绩记录**
                           (student_id)                    students(student_id)                                          
                                                           ON DELETE CASCADE                          

  **外键2**                fk_grade_course                 REFERENCES                关联课程表       **课程删除时，同步删除成绩记录**
                           (course_id)                     courses(course_id)                                          
                                                           ON DELETE CASCADE                          

  **外键3**                fk_grade_teacher                REFERENCES                关联教师表       **教师删除时，同步删除成绩记录**
                           (teacher_id)                    teachers(teacher_id)                                          
                                                           ON DELETE CASCADE                          

  **性能索引1**            idx_student                     -                         学生索引         优化按学生查询成绩的性能

  **性能索引2**            idx_teacher                     -                         教师索引         优化按教师查询成绩的性能

  **性能索引3**            idx_semester                    -                         学期索引         优化按学期查询成绩的性能

  **性能索引4**            idx_status                      -                         状态索引         优化按状态查询成绩的性能

  **性能索引5**            idx_exam_type                   -                         考试类型索引     优化按考试类型查询成绩的性能
------------------------ ------------------------------- ------------------------- ---------------- --------------------------------------------------------------------------------

**4.5 安全审计日志表（security_log）**

---------------- ----------------------------------------- ------------------------- --------------- ------------------------------
  字段名           数据类型                                  约束条件                  注释            补充说明

  log_id           BIGINT                                    AUTO_INCREMENT、PRIMARY   日志ID          自增主键，唯一标识每条日志
                                                             KEY                                       

  operation_type   VARCHAR(20)                               NOT NULL                  操作类型        INSERT/UPDATE/DELETE

  table_name       VARCHAR(50)                               NOT NULL                  操作表名        如"grade_records""students"

  record_id        VARCHAR(50)                               NULL                      记录ID          被操作记录的主键值

  operator_id      VARCHAR(20)                               NOT NULL                  操作人ID        学生/教师/管理员的ID

  operator_type    ENUM('STUDENT','TEACHER','ADMIN')         NULL                      操作人类型      区分操作人身份

  data_hash        VARCHAR(64)                               NULL                      数据哈希        操作后的数据哈希值，用于校验

  client_ip        VARCHAR(45)                               NULL                      客户端IP        记录操作来源IP（支持IPv6）

  operation_time   TIMESTAMP                                 DEFAULT                   操作时间        自动记录操作发生时间
                                                           CURRENT_TIMESTAMP                          

  **索引1**        idx_operator                              -                         操作人索引      优化按操作人查询日志的性能
                   (operator_id)                                                                      

  **索引2**        idx_operation_time                        -                         操作时间索引    优化按时间范围查询日志的性能
                   (operation_time)                                                                   

  **索引3**        idx_table_record                          -                         表+记录ID索引   优化按表+记录查询日志的性能
                   (table_name, record_id)                                                            
---------------- ----------------------------------------- ------------------------- --------------- ------------------------------

---

**5. 数据关系模型**

**5.1 核心关联关系**

**学生-成绩**：一对多（1个学生对应多条成绩记录），通过`student_id`关联，**级联删除**；

**教师-课程**：一对多（1个教师可讲授多门课程），通过`teacher_id`关联，**删除教师时课程置空**；

**教师-成绩**：一对多（1个教师可录入多条成绩记录），通过`teacher_id`关联，**级联删除**；

**课程-成绩**：一对多（1门课程对应多条成绩记录），通过`course_id`关联，**级联删除**；

**审计日志-业务表**：多对多（1条业务记录的操作对应多条日志，1条日志仅对应1条业务记录），通过`table_name+record_id`关联。

**5.2 ER图（文字描述）**

```
students (1) ----< (N) grade_records (N) >---- (1) courses
      ^                                      ^
      |                                      |
      +----< (N) grade_records (N) >--------+---- (1) teachers

security_log 独立记录所有表的操作，通过table_name+record_id关联
```

**5.3 关键约束说明图**

```
grade_records表：
- 同一学生 + 同一课程 + 同一学期 + 同一考试类型 + 同一状态 = 唯一记录
- 示例：2021001234 + CS202 + 2024-2025-1 + 正考 + SUBMITTED = 仅允许1条 ✅
- 示例：2021001234 + CS202 + 2024-2025-1 + 补考 + SUBMITTED = 允许共存 ✅
- 示例：2021001234 + CS202 + 2024-2025-1 + 正考 + DRAFT = 允许共存 ✅
- 示例：2021001234 + CS202 + 2024-2025-1 + 正考 + SUBMITTED + 另一条正考SUBMITTED = 冲突 ❌
```

---

**6. 核心设计规则（V1.1修订版）**

**6.1 外键约束规则**

- **级联删除**：学生/教师/课程表的记录删除时，关联的成绩记录**自动删除**，避免脏数据；
- **置空规则**：课程表关联的教师删除时，课程的`teacher_id`设为NULL（课程保留，仅清空任课教师）；
- **非空约束**：成绩记录的核心关联字段（`student_id`/`course_id`/`teacher_id`）不允许为空，确保数据可追溯。

**6.2 业务唯一性约束规则（V1.1新增）**

**约束名称**：`uk_grade`

**作用字段**：`(student_id, course_id, semester, exam_type, status)`

**业务含义**：
- **防止重复录入**：同一学生在同一学期、同一门课程、同一考试类型下，**只能有一个暂存草稿**和**一个已提交成绩**；
- **正考补考共存**：`exam_type`区分正考/补考，允许两者**同时存在**（合理业务场景）；
- **状态互斥**：`status`区分DRAFT/SUBMITTED，确保同一状态下无重复记录。

**实现方式**：数据库层`UNIQUE KEY` + 应用层前置检查双重保障。

**6.3 生成列（data_hash）规则（V1.1明确）**

**计算逻辑**：`SHA2(CONCAT_WS('_', student_id, course_id, exam_type, COALESCE(total_score_encrypted,'')), 256)`

**类型**：**VIRTUAL虚拟列**，查询时实时计算，不占用物理存储，避免与外键冲突；

**用途**：**防篡改校验**，定期执行 `SELECT data_hash, SHA2(...) FROM grade_records` 比对，若不一致说明数据被非法修改。

**6.4 数据加密规则**

- **加密字段**：所有成绩相关字段（`daily_score_encrypted`/`final_score_encrypted`/`makeup_score_encrypted`/`total_score_encrypted`）均采用**AES对称加密**存储，仅系统解密后展示；
- **密码存储**：学生/教师密码采用**BCrypt哈希算法**加密，不可逆，防止密码泄露。

**6.5 审计规则**

- **记录范围**：所有对业务表（students/teachers/courses/grade_records）的INSERT/UPDATE/DELETE操作必须记录日志；
- **日志内容**：需包含操作人、操作类型、操作时间、客户端IP、数据哈希，确保操作可溯源、数据可校验。

---

**7. 测试数据说明**

**7.1 测试数据内容**

脚本中包含可选的测试数据，用于验证数据库功能，具体如下：

----------------------------------- ----------------------------------------------------------------------------------------------------------------------------------
  表名                                测试数据示例

  students                            学号：2021001234，姓名：张三，班级：软件2101，专业：软件工程；<br>学号：2021005678，姓名：李四，班级：软件2101，专业：软件工程

  teachers                            教师编号：T001，姓名：王教授，院系：信息工程学院，职称：教授

  courses                             课程编号：CS202，课程名称：数据结构，学分：4.0，任课教师：T001，学期：2024-2025-1

  grade_records                       学号：2021001234，课程编号：CS202，总成绩（加密）：AES_90，考试类型：正考，状态：已提交，**data_hash自动计算**
----------------------------------- ----------------------------------------------------------------------------------------------------------------------------------

**7.2 测试数据用途**

- 验证表结构和外键关联的正确性；
- **验证生成列data_hash的计算逻辑**；
- **验证唯一性约束uk_grade的生效情况**；
- 为系统功能测试提供基础数据。

---

**8. 维护与运维建议（V1.1补充）**

**8.1 日常维护**

- **外键检查**：定期执行`SET FOREIGN_KEY_CHECKS = 1`验证外键完整性，避免数据不一致；
- **索引优化**：根据实际查询频率分析慢查询日志，避免冗余索引；
- **唯一性监控**：定期执行`SELECT ... GROUP BY ... HAVING COUNT(*) > 1`检查唯一约束是否被绕过；
- **日志清理**：定期归档`security_log`表的历史日志（如超过1年的日志），提升查询性能。

**8.2 安全运维**

- **禁止直接修改**：严禁直接修改`grade_records`表的成绩数据，所有修改需通过系统接口并记录审计日志；
- **定期校验**：每月执行`SELECT data_hash, SHA2(...) FROM grade_records WHERE data_hash != SHA2(...)`检测数据篡改；
- **权限控制**：严格控制数据库账号权限，仅管理员可访问`security_log`表，开发人员仅赋予SELECT权限。

**8.3 扩展建议**

- **多校区支持**：如需支持多校区管理，可在`courses`/`grade_records`表添加`campus`字段；
- **等级制支持**：如需支持成绩等级制（如优/良/中），可扩展`exam_type`枚举或新增`score_level`字段；
- **分表策略**：如数据量超过千万级，建议按`semester`字段对`grade_records`表进行分区或分表。

---

**9. 附录**

**9.1 常用查询示例**

查询某学生的所有成绩：
```sql
SELECT g.*, s.name, c.course_name 
FROM grade_records g
JOIN students s ON g.student_id = s.student_id
JOIN courses c ON g.course_id = c.course_id
WHERE g.student_id = '2021001234';
```

查询某教师录入的已提交成绩：
```sql
SELECT g.*, s.name 
FROM grade_records g
JOIN students s ON g.student_id = s.student_id
WHERE g.teacher_id = 'T001' AND g.status = 'SUBMITTED';
```

校验成绩数据哈希（防篡改）：
```sql
SELECT record_id, data_hash,
       SHA2(CONCAT_WS('_', student_id, course_id, exam_type, COALESCE(total_score_encrypted,'')), 256) AS computed_hash
FROM grade_records
WHERE data_hash != computed_hash;
```

**9.2 错误码说明**

----------------------- ------------------------ ---------------------------------------------
  错误码                  原因                     解决方案

  **1062**                违反唯一性约束`uk_grade`   **应用层检查重复**，数据库自动拦截非法写入

  1215                    外键约束不满足           确保关联字段数据类型/字符集一致，父表先创建

  3192                    存储型生成列依赖外键列   将生成列改为**VIRTUAL**，或先加外键再加生成列
----------------------- ------------------------ ---------------------------------------------

**9.3 版本修订历史**

---------- -------------------- -------------------------------------------
  版本       修订日期             修订内容

  V1.0       2025年11月           初始版本，定义基础表结构

  **V1.1**   **2025年12月**       **补充`uk_grade`唯一性约束实现**、
                                 **明确`data_hash`生成列逻辑**、
                                 **增加业务规则与运维建议**
---------- -------------------- -------------------------------------------

---

**文档维护声明**

本文档由系统自动生成，反映当前生产数据库的实际结构。任何表结构变更需同步更新本文档，并提交至版本控制系统（Git）进行版本管理。

**（本文档已按实际数据库结构修订完毕，符合MySQL 8.0+生产环境要求）**